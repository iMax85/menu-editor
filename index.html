<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èœå–®ç·¨è¼¯å™¨</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { padding: 20px 15px; background-color: #f8f9fa; font-family: sans-serif; }
    .card { border-radius: 16px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .btn-save { background-color: #06c755; color: white; border: none; font-weight: bold; border-radius: 50px; }
    .btn-save:hover { background-color: #05b34c; color: white; }
    .form-control:focus { box-shadow: none; border-color: #06c755; }
    .status-bar { font-size: 12px; color: #888; text-align: center; margin-bottom: 15px; }
  </style>
</head>
<body>
  <div class="container p-0" style="max-width: 600px;">
    <div class="card p-4">
      <h5 class="mb-1 text-center fw-bold">ğŸ± èœå–®ç¢ºèª</h5>
      <p class="status-bar">å‹¾é¸è¦åŠ å…¥çš„é …ç›®ï¼Œä¸¦æŒ‡å®šåº—å</p>
      
      <div id="menuList"></div>
      
      <div id="loading" class="text-center py-5">
        <div class="spinner-border text-success" role="status"></div>
        <div class="mt-2 small text-muted">æ­£åœ¨è§£æè³‡æ–™...</div>
      </div>

      <button id="submitBtn" class="btn btn-save w-100 py-3 mt-4 shadow-sm" onclick="submit()" style="display:none;">
        ç¢ºèªå‚³é€ (Save)
      </button>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // âš ï¸âš ï¸ è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ LIFF ID âš ï¸âš ï¸
    const LIFF_ID = '2008843970-PeS3Eu6o'; 
    // âš ï¸ è«‹å¡«å…¥æ‚¨å‰›å‰›éƒ¨ç½² GAS å¾Œç”¢ç”Ÿçš„ç¶²å€ (çµå°¾æ˜¯ /exec)
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzDPUvZg5-vxSV5mRC7qfsgNyez18dLorbwRItZ_ALXDsxbW7pC_I3PAuTEEe530BYQWA/exec';
    <!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èœå–®ç·¨è¼¯å™¨</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { padding: 20px 15px; background-color: #f8f9fa; font-family: sans-serif; }
    .card { border-radius: 16px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .btn-save { background-color: #06c755; color: white; border: none; font-weight: bold; border-radius: 50px; }
    /* ... æ¨£å¼ä¿ç•™ ... */
  </style>
</head>
<body>
  <div class="container p-0" style="max-width: 600px;">
    <div class="card p-4">
      <h5 class="mb-1 text-center fw-bold">ğŸ± èœå–®ç¢ºèª</h5>
      <div id="menuList"></div>
      <div id="loading" class="text-center py-5">
        <div class="spinner-border text-success" role="status"></div>
        <div class="mt-2 small text-muted">æ­£åœ¨è®€å–è³‡æ–™...</div>
      </div>
      <button id="submitBtn" class="btn btn-save w-100 py-3 mt-4 shadow-sm" onclick="submit()" style="display:none;">
        ç¢ºèªå‚³é€ (Save)
      </button>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = 'æ‚¨çš„_LIFF_ID'; 
    
    // âš ï¸ è«‹å¡«å…¥æ‚¨å‰›å‰›éƒ¨ç½² GAS å¾Œç”¢ç”Ÿçš„ç¶²å€ (çµå°¾æ˜¯ /exec)
    const GAS_API_URL = 'https://script.google.com/macros/s/æ‚¨çš„_GAS_ID/exec';

    async function init() {
      // 1. å–å¾—ç¶²å€ä¸Šçš„è™Ÿç¢¼ç‰Œ (row ID)
      const urlParams = new URLSearchParams(window.location.search);
      const rowId = urlParams.get('row');
      
      if (!rowId) {
        document.getElementById('loading').innerHTML = "âŒ ç¶²å€ç¼ºå°‘åƒæ•¸";
        return;
      }

      try {
        // 2. è·Ÿ GAS è¦è³‡æ–™ (fetch)
        const response = await fetch(GAS_API_URL + "?row=" + rowId);
        const items = await response.json();
        
        renderList(items);
      } catch (e) {
        document.getElementById('loading').innerHTML = "âŒ è³‡æ–™è®€å–å¤±æ•—<br>" + e.message;
      }
    }

    function renderList(items) {
      document.getElementById('loading').style.display = 'none';
      const list = document.getElementById('menuList');
      const btn = document.getElementById('submitBtn');
      
      if (!items || items.length === 0) {
        list.innerHTML = "æ²’æœ‰è³‡æ–™";
        return;
      }
      
      btn.style.display = 'block';
      items.forEach((item, i) => {
        // ... (é€™è£¡ç”¢ç”Ÿ HTML çš„é‚è¼¯è·Ÿä¹‹å‰ä¸€æ¨£) ...
        list.innerHTML += `
          <div class="d-flex align-items-center mb-3 p-2 bg-white border-bottom">
            <div class="flex-grow-1">
              <input type="text" class="form-control form-control-sm border-0 fw-bold" value="${item.name}" id="n${i}">
              <input type="text" class="form-control form-control-sm border-0 text-muted" value="${item.price}" id="p${i}">
            </div>
            <div class="d-flex flex-column align-items-center ms-2">
              <div class="form-check mb-2">
                <input type="checkbox" class="form-check-input" id="a${i}" checked>
              </div>
              <div class="form-check">
                <input type="radio" name="store" class="form-check-input" id="s${i}">
              </div>
            </div>
          </div>`;
      });
      window.menuItems = items; // æš«å­˜çµ¦ submit ç”¨
    }

    // ... (submit å‡½æ•¸è·Ÿä¹‹å‰ä¸€æ¨£ï¼Œä¸éœ€è¦æ”¹) ...
    async function submit() {
       // ... è¤‡è£½ä¹‹å‰çš„ submit é‚è¼¯ ...
       // è¨˜å¾—: éæ­· window.menuItems ä¾†æŠ“å– DOM æ•¸å€¼
        try {
        document.getElementById('submitBtn').innerHTML = "è™•ç†ä¸­...";
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }

        let storeName = "æœªè¨­å®šåº—å";
        let finalArr = [];
        
        window.menuItems.forEach((_, i) => {
          const name = document.getElementById(`n${i}`).value;
          const price = document.getElementById(`p${i}`).value;
          if (document.getElementById(`s${i}`).checked) storeName = name;
          if (document.getElementById(`a${i}`).checked) finalArr.push({ name, price });
        });

        const msgText = `/SAVE_LIBRARY|${storeName}|${JSON.stringify(finalArr)}`;
        if (liff.isInClient()) {
          await liff.sendMessages([{ type: 'text', text: msgText }]);
          liff.closeWindow();
        }
      } catch (err) { alert("éŒ¯èª¤: " + err.message); }
    }

    init();
  </script>
</body>
</html>

    // 1. è§£æç¶²å€ä¸­çš„è³‡æ–™ (Data from Hash) - ä¿®æ­£ä¸­æ–‡äº‚ç¢¼ç‰ˆ
    function loadDataFromUrl() {
      try {
        const hash = window.location.hash.substring(1); // å–å¾— # å¾Œé¢çš„å­—ä¸²
        if (!hash) return [];
    
        // è™•ç† Base64 WebSafe å­—å…ƒæ›¿æ› (-_ è½‰ç‚º +/)
        let base64 = hash.replace(/-/g, '+').replace(/_/g, '/');
        // è£œé½Š padding (=)
        while (base64.length % 4) { base64 += '='; }

        // ===== é—œéµä¿®æ­£é–‹å§‹ =====
        // 1. å°‡ Base64 è§£ç¢¼ç‚ºäºŒé€²ä½å­—ä¸²
        const binaryString = window.atob(base64);
        // 2. å°‡äºŒé€²ä½å­—ä¸²è½‰æ›ç‚ºä½å…ƒçµ„é™£åˆ— (Uint8Array)
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        // 3. ä½¿ç”¨ TextDecoder å°‡ä½å…ƒçµ„é™£åˆ—æ­£ç¢ºè§£ç¢¼ç‚º UTF-8 ä¸­æ–‡å­—ä¸²
        const jsonString = new TextDecoder('utf-8').decode(bytes);
        // ===== é—œéµä¿®æ­£çµæŸ =====

        return JSON.parse(jsonString);
      } catch (e) {
        console.error(e);
        // alert("è³‡æ–™è®€å–éŒ¯èª¤ï¼š" + e.message); // å»ºè­°è¨»è§£æ‰ alertï¼Œé¿å…å¹²æ“¾é«”é©—
        return [];
      }
    }

    // 2. åˆå§‹åŒ–ç•«é¢
    const items = loadDataFromUrl();
    const list = document.getElementById('menuList');
    const loading = document.getElementById('loading');
    const btn = document.getElementById('submitBtn');

    loading.style.display = 'none';

    if (items.length === 0) {
      list.innerHTML = "<div class='text-center text-danger py-3'>âš ï¸ æ²’æœ‰è³‡æ–™<br>è«‹é‡æ–°å¾ LINE é–‹å•Ÿé€£çµ</div>";
    } else {
      btn.style.display = 'block';
      items.forEach((item, i) => {
        list.innerHTML += `
          <div class="d-flex align-items-center mb-3 p-2 bg-white border-bottom">
            <div class="flex-grow-1">
              <input type="text" class="form-control form-control-sm border-0 fw-bold" value="${item.name}" id="n${i}" style="background:transparent;">
              <input type="text" class="form-control form-control-sm border-0 text-muted" value="${item.price}" id="p${i}" style="font-size:12px; height:auto; background:transparent;">
            </div>
            <div class="d-flex flex-column align-items-center ms-2">
              <div class="form-check mb-2">
                <input type="checkbox" class="form-check-input" id="a${i}" checked style="cursor:pointer; transform: scale(1.2);">
              </div>
              <div class="form-check">
                <input type="radio" name="store" class="form-check-input" id="s${i}" style="cursor:pointer;">
              </div>
            </div>
          </div>`;
      });
    }

    // 3. å›å‚³è³‡æ–™çµ¦æ©Ÿå™¨äºº
    async function submit() {
      try {
        btn.innerHTML = "è™•ç†ä¸­...";
        btn.disabled = true;

        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        let storeName = "æœªè¨­å®šåº—å";
        let finalArr = [];
        
        items.forEach((_, i) => {
          const name = document.getElementById(`n${i}`).value;
          const price = document.getElementById(`p${i}`).value;
          
          if (document.getElementById(`s${i}`).checked) storeName = name;
          // åªæœ‰å‹¾é¸åŠ å…¥çš„æ‰å›å‚³
          if (document.getElementById(`a${i}`).checked) {
            finalArr.push({ name, price });
          }
        });

        // çµ„åˆæŒ‡ä»¤
        const msgText = `/SAVE_LIBRARY|${storeName}|${JSON.stringify(finalArr)}`;
        
        if (liff.isInClient()) {
          await liff.sendMessages([{ type: 'text', text: msgText }]);
          liff.closeWindow();
        } else {
          alert("è«‹åœ¨ LINE App å…§ä½¿ç”¨æ­¤åŠŸèƒ½ä»¥å›å‚³è¨Šæ¯ã€‚");
        }

      } catch (err) {
        alert("å‚³é€å¤±æ•—ï¼š" + err.message);
        btn.innerHTML = "ç¢ºèªå‚³é€ (Save)";
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
