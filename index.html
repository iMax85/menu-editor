<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èœå–®ç·¨è¼¯å™¨</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { padding: 15px; background-color: #f8f9fa; font-family: sans-serif; }
    .card { border-radius: 16px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .btn-save { background-color: #06c755; color: white; border: none; font-weight: bold; border-radius: 50px; }
    .form-control:focus { box-shadow: none; border-color: #06c755; }
    .store-header { background-color: #eef9f1; border: 2px solid #06c755; border-radius: 12px; }
  </style>
</head>
<body>
  <div class="container p-0" style="max-width: 600px;">
    <div class="card p-3">
      <h5 class="mb-3 text-center fw-bold">ğŸ± èœå–®ç¢ºèªèˆ‡å­˜æª”</h5>
      <div id="menuList"></div>
      <div id="loading" class="text-center py-5">
        <div class="spinner-border text-success"></div>
        <div class="mt-2 small text-muted">æ­£åœ¨è®€å–è³‡æ–™...</div>
      </div>
      <button id="submitBtn" class="btn btn-save w-100 py-3 mt-4 shadow-sm" onclick="submit()" style="display:none;">ç¢ºèªä¸¦æ›´æ–°åœ–æ›¸é¤¨</button>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = '2008843970-PeS3Eu6o'; 
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzDPUvZg5-vxSV5mRC7qfsgNyez18dLorbwRItZ_ALXDsxbW7pC_I3PAuTEEe530BYQWA/exec';

    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      let rowId = urlParams.get('row');
      if (!rowId && urlParams.has('liff.state')) {
        const liffState = urlParams.get('liff.state');
        const nestedParams = new URLSearchParams(liffState.startsWith('?') ? liffState : '?' + liffState);
        rowId = nestedParams.get('row');
      }
      if (!rowId) { document.getElementById('loading').innerHTML = "âŒ ç¼ºå°‘åƒæ•¸"; return; }

      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login({ redirectUri: window.location.href }); return; }
        const response = await fetch(GAS_API_URL + "?row=" + rowId);
        const data = await response.json();
        renderList(data);
      } catch (e) { alert("è®€å–å¤±æ•—: " + e.message); }
    }

    function renderList(items) {
      document.getElementById('loading').style.display = 'none';
      const list = document.getElementById('menuList');
      document.getElementById('submitBtn').style.display = 'block';
      window.menuItems = items || [];
      
      let html = `
        <div class="store-header p-3 mb-3">
          <div class="mb-2">
            <label class="small fw-bold text-success">ğŸ  åº—å®¶åç¨±</label>
            <input type="text" class="form-control form-control-sm border-0 fw-bold" value="è«‹è¼¸å…¥åº—å®¶åç¨±" id="storeName" onfocus="if(this.value=='è«‹è¼¸å…¥åº—å®¶åç¨±')this.value=''" style="background:transparent; font-size:16px;">
          </div>
          <div>
            <label class="small fw-bold text-success">ğŸ“ è¯çµ¡é›»è©±</label>
            <input type="text" class="form-control form-control-sm border-0" placeholder="è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼" id="storePhone" style="background:transparent;">
          </div>
        </div>
        <div class="row g-0 mb-1 px-2 text-muted small fw-bold">
          <div class="col-7">å“é …åç¨±</div><div class="col-3 text-center">åƒ¹æ ¼</div><div class="col-2 text-end">åŠ å…¥</div>
        </div><hr class="mt-0">`;

      window.menuItems.forEach((item, i) => {
        html += `
          <div class="row g-1 align-items-center mb-2 pb-2 border-bottom">
            <div class="col-7"><input type="text" class="form-control form-control-sm border-0 fw-bold" value="${item.name}" id="n${i}" style="background:transparent;"></div>
            <div class="col-3"><input type="text" class="form-control form-control-sm border-0 text-center" value="${item.price}" id="p${i}" style="background:transparent;"></div>
            <div class="col-2 text-end"><input type="checkbox" class="form-check-input" id="a${i}" checked></div>
          </div>`;
      });
      list.innerHTML = html;
    }

    async function submit() {
      const sName = document.getElementById('storeName').value;
      const sPhone = document.getElementById('storePhone').value;
      if (sName === "è«‹è¼¸å…¥åº—å®¶åç¨±" || !sName.trim()) { alert("è«‹å¡«å¯«åº—å"); return; }
      
      let finalArr = [];
      window.menuItems.forEach((_, i) => {
        if (document.getElementById(`a${i}`).checked) {
          finalArr.push({ name: document.getElementById(`n${i}`).value, price: document.getElementById(`p${i}`).value });
        }
      });

      // ä¿®æ”¹å›å‚³æ ¼å¼ï¼š/SAVE_LIBRARY|åº—å|é›»è©±|JSON
      const cmd = `/SAVE_LIBRARY|${sName}|${sPhone}|${JSON.stringify(finalArr)}`;
      await liff.sendMessages([{ type: 'text', text: cmd }]);
      liff.closeWindow();
    }
    init();
  </script>
</body>
</html>
