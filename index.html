<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èœå–®ç·¨è¼¯å™¨</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { padding: 20px 15px; background-color: #f8f9fa; font-family: sans-serif; }
    .card { border-radius: 16px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .btn-save { background-color: #06c755; color: white; border: none; font-weight: bold; border-radius: 50px; }
  </style>
</head>
<body>
  <div class="container p-0" style="max-width: 600px;">
    <div class="card p-4">
      <h5 class="mb-1 text-center fw-bold">ğŸ± èœå–®ç¢ºèª</h5>
      <div id="menuList"></div>
      
      <div id="loading" class="text-center py-5">
        <div class="spinner-border text-success" role="status"></div>
        <div class="mt-2 small text-muted">æ­£åœ¨è®€å–è³‡æ–™...</div>
      </div>

      <button id="submitBtn" type="button" class="btn btn-save w-100 py-3 mt-4 shadow-sm" onclick="submit()" style="display:none;">
        ç¢ºèªå‚³é€ (Save)
      </button>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = '2008843970-PeS3Eu6o'; // âš ï¸ è«‹ç¢ºèª ID æ­£ç¢º
    // âš ï¸ è«‹ç¢ºèªé€™è£¡æ˜¯æ‚¨ GAS éƒ¨ç½²å¾Œç”¢ç”Ÿçš„ç¶²å€ (çµå°¾æ˜¯ /exec)
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzDPUvZg5-vxSV5mRC7qfsgNyez18dLorbwRItZ_ALXDsxbW7pC_I3PAuTEEe530BYQWA/exec';

    // å…¨åŸŸè®Šæ•¸å„²å­˜è³‡æ–™
    window.menuItems = [];

    // 1. åˆå§‹åŒ–æµç¨‹
    async function init() {
      const loadingEl = document.getElementById('loading');
      
      // --- æ™ºæ…§åµæ¸¬ rowId é–‹å§‹ ---
      const urlParams = new URLSearchParams(window.location.search);
      let rowId = urlParams.get('row');
      
      // å¦‚æœç›´æ¥æ‰¾ä¸åˆ° rowï¼Œå°±å»æª¢æŸ¥æ˜¯å¦è¢«åŒ…åœ¨ liff.state è£¡é¢
      if (!rowId && urlParams.has('liff.state')) {
        const liffState = urlParams.get('liff.state');
        // liffState çš„å…§å®¹å¯èƒ½æ˜¯ "?row=4" æˆ– "row=4"
        const nestedParams = new URLSearchParams(liffState.startsWith('?') ? liffState : '?' + liffState);
        rowId = nestedParams.get('row');
      }
      // --- æ™ºæ…§åµæ¸¬ rowId çµæŸ ---
      
      if (!rowId) {
        loadingEl.innerHTML = "<h3 class='text-danger'>âŒ ç¶²å€ç¼ºå°‘åƒæ•¸</h3><p>åµæ¸¬ä¸åˆ° row ç·¨è™Ÿ</p>";
        return;
      }

      try {
        // å•Ÿå‹• LIFF
        await liff.init({ liffId: LIFF_ID });
        
        // ç™»å…¥æª¢æŸ¥èˆ‡å°å‘
        if (!liff.isLoggedIn()) {
          // ç¢ºä¿ç™»å…¥å¾Œå°å‘å›å¸¶æœ‰åƒæ•¸çš„å®Œæ•´ç¶²å€
          liff.login({ redirectUri: window.location.href });
          return;
        }

        // å‘ GAS è«‹æ±‚è³‡æ–™ (ä¿æŒåŸæœ¬é‚è¼¯)
        loadingEl.innerHTML = `<div class="spinner-border text-success"></div><div class="mt-2">æ­£åœ¨è®€å–ç¬¬ ${rowId} ç­†è³‡æ–™...</div>`;
        const response = await fetch(GAS_API_URL + "?row=" + rowId);
        const data = await response.json();
        
        if (data.error) throw new Error(data.error);
        renderList(data);

      } catch (e) {
        loadingEl.innerHTML = `<h5 class='text-danger'>è®€å–å¤±æ•—</h5><p class='small text-muted'>${e.message}</p>`;
      }
    }

    // 2. æ¸²æŸ“åˆ—è¡¨
    // 2. æ¸²æŸ“åˆ—è¡¨ (æ°´å¹³ä¸¦åˆ—å„ªåŒ–ç‰ˆ)
    function renderList(items) {
      document.getElementById('loading').style.display = 'none';
      const list = document.getElementById('menuList');
      const btn = document.getElementById('submitBtn');
      
      if (!items) items = [];
      window.menuItems = items; 
      btn.style.display = 'block';
      
      let html = "";

      // ğŸ’¡ 1. å›ºå®šç”¢ç”Ÿç¬¬ä¸€åˆ—ï¼šé¤å»³åç¨± (ç¶­æŒç‰¹æ®Šæ¨£å¼)
      html += `
        <div class="p-2 mb-3 bg-light rounded border-primary border" style="border-width: 2px !important;">
          <label class="small text-primary fw-bold mb-1">ğŸ  é¤å»³åç¨±</label>
          <div class="d-flex align-items-center">
            <input type="text" class="form-control form-control-sm border-0 fw-bold text-primary flex-grow-1" 
                   value="è«‹è¼¸å…¥åº—å®¶åç¨±" id="storeNameInput" 
                   onfocus="if(this.value=='è«‹è¼¸å…¥åº—å®¶åç¨±')this.value=''" style="background:transparent;">
            <div class="ms-2 d-flex align-items-center">
              <input type="checkbox" class="form-check-input me-2" checked disabled>
              <input type="radio" name="store" class="form-check-input" checked disabled>
            </div>
          </div>
        </div>
        <div class="row g-0 mb-2 px-2 text-muted small fw-bold">
          <div class="col-7">å“é …åç¨±</div>
          <div class="col-3 text-center">åƒ¹æ ¼</div>
          <div class="col-2 text-end">åŠ å…¥</div>
        </div>
        <hr class="mt-0">`;

      // ğŸ’¡ 2. ç”¢ç”Ÿèœå–®å“é … (å“é …èˆ‡åƒ¹æ ¼æ”¾åœ¨åŒä¸€æ°´å¹³åˆ—)
      items.forEach((item, i) => {
        html += `
          <div class="row g-1 align-items-center mb-2 pb-2 border-bottom">
            <div class="col-7">
              <input type="text" class="form-control form-control-sm border-0 fw-bold p-1" 
                     value="${item.name}" id="n${i}" style="background:transparent;">
            </div>
            <div class="col-3">
              <input type="text" class="form-control form-control-sm border-0 text-success p-1 text-center" 
                     value="${item.price}" id="p${i}" style="background:transparent; font-weight:500;">
            </div>
            <div class="col-2 text-end px-2">
              <input type="checkbox" class="form-check-input" id="a${i}" checked style="transform: scale(1.1);">
            </div>
          </div>`;
      });
      list.innerHTML = html;
    }
    
    // 3. é€å‡ºè³‡æ–™ (é…åˆæ–° UI ä¿®æ”¹)
    async function submit() {
      const btn = document.getElementById('submitBtn');
      try {
        if (!liff.isLoggedIn()) { liff.login({ redirectUri: window.location.href }); return; }

        btn.innerHTML = "è™•ç†ä¸­...";
        btn.disabled = true;

        // ğŸ’¡ æŠ“å–ç¬¬ä¸€åˆ—å›ºå®šçš„åº—å
        let storeName = document.getElementById('storeNameInput').value;
        if (storeName === "è«‹è¼¸å…¥åº—å®¶åç¨±" || storeName.trim() === "") {
          alert("è«‹å…ˆè¼¸å…¥åº—å®¶åç¨±å†å­˜æª”ï¼");
          btn.innerHTML = "ç¢ºèªå‚³é€ (Save)";
          btn.disabled = false;
          return;
        }

        let finalArr = [];
        window.menuItems.forEach((_, i) => {
          const name = document.getElementById(`n${i}`).value;
          const price = document.getElementById(`p${i}`).value;
          // åªæœ‰å‹¾é¸åŠ å…¥çš„å“é …æ‰å­˜å…¥
          if (document.getElementById(`a${i}`).checked) {
            finalArr.push({ name, price });
          }
        });

        const msgText = `/SAVE_LIBRARY|${storeName}|${JSON.stringify(finalArr)}`;

        if (liff.isInClient()) {
          await liff.sendMessages([{ type: 'text', text: msgText }]);
          liff.closeWindow();
        } else {
          alert("è«‹åœ¨ LINE App å…§ä½¿ç”¨");
          btn.disabled = false;
        }
      } catch (err) {
        alert("éŒ¯èª¤: " + err.message);
        btn.disabled = false;
      }
    }

    // å•Ÿå‹•
    init();
  </script>
</body>
</html>
