<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èœå–®ç·¨è¼¯å™¨(II)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background-color: #f8f9fa; padding: 20px; }
    .item-row { background: white; padding: 10px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .del-btn { color: red; font-weight: bold; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container" style="max-width: 600px;">
    <h4 class="mb-3 text-center fw-bold">ğŸ“ èœå–®ç·¨è¼¯ç¢ºèª</h4>
    
    <div class="mb-3">
      <label class="form-label">åº—å®¶åç¨±</label>
      <input type="text" id="storeName" class="form-control" placeholder="è«‹è¼¸å…¥åº—å">
    </div>
    <div class="mb-3">
      <label class="form-label">è¯çµ¡é›»è©±</label>
      <input type="text" id="storePhone" class="form-control" placeholder="é¸å¡«">
    </div>

    <hr>
    <div id="itemsContainer"></div>
    
    <button class="btn btn-outline-secondary w-100 mb-2" onclick="addItem()">+ æ–°å¢å“é …</button>
    <button id="saveBtn" class="btn btn-success w-100 py-2 fw-bold" onclick="saveData()">âœ… ç¢ºèªä¸¦æ›´æ–°è³‡æ–™åº«</button>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // âš ï¸ è«‹å‹™å¿…æ›æˆæ‚¨ã€Œæ–°å»ºã€çµ¦ç·¨è¼¯å™¨ç”¨çš„ LIFF ID
    const LIFF_ID = '2008939522-4Z8U3nvA'; 
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyDcGGvYcChszNtJRFL-HLD7Tv8aUmICLiCi4b2xhhPLtKCnO_NiRUViyL6gbQyq80ELA/exec'; 

    const urlParams = new URLSearchParams(window.location.search);
    const rowId = urlParams.get('row');     // ä¾†è‡ª OCR çš„æš«å­˜è¡Œè™Ÿ
    const storeParam = urlParams.get('store'); // ğŸš€ ä¾†è‡ªç®¡ç†å“¡çš„åº—å

    let currentItems = [];
    
    async function init() {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) { liff.login(); return; }

      // åˆ¤æ–·æ˜¯ã€Œæ–°OCRã€é‚„æ˜¯ã€Œä¿®æ”¹èˆŠè³‡æ–™ã€
      if (storeParam) {
        loadExistingStoreData(storeParam); // ğŸš€ è¼‰å…¥èˆŠè³‡æ–™æ¨¡å¼
      } else if (rowId) {
        loadTempData(rowId); // è¼‰å…¥ OCR æš«å­˜æ¨¡å¼
      }
    }

    // ğŸš€ æ–°å¢ï¼šè¼‰å…¥èˆŠåº—å®¶è³‡æ–™
    async function loadExistingStoreData(store) {
      document.getElementById('saveBtn').innerText = "ğŸ”„ æ›´æ–°ç¾æœ‰è³‡æ–™";
      try {
        // å‘¼å«å‰›å‰›åœ¨ doGet æ–°å¢çš„ getStoreFullData
        const res = await fetch(`${GAS_API_URL}?action=getStoreFullData&store=${encodeURIComponent(store)}`);
        const data = await res.json();
        
        // å¡«å…¥è³‡æ–™
        document.getElementById('storeName').value = data.storeName;
        document.getElementById('storePhone').value = data.storePhone; // é€™è£¡æœƒè‡ªå‹•å¡«å…¥é›»è©±
        renderItems(data.menuItems);
      } catch (e) {
        alert("è®€å–åº—å®¶è³‡æ–™å¤±æ•—ï¼š" + e.message);
      }
    }

    async function loadTempData() {
      if (!rowId) return; // å¦‚æœæ²’æœ‰è¡Œè™Ÿå°±ä¸è®€å–
      try {
        const res = await fetch(`${GAS_API_URL}?action=getTemp&row=${rowId}`);
        const data = await res.json();
        // å¦‚æœ OCR æœ‰æŠ“åˆ°åº—å(å‡è¨­å­˜æª”æ ¼å¼æ”¯æ´)ï¼Œé€™è£¡ä¹Ÿå¯ä»¥é å¡«
        // ç›®å‰å…ˆå¡«å…¥å“é …
        renderItems(data); 
      } catch(e) {
        console.error(e);
      }
    }

    function renderItems(items) {
      const container = document.getElementById('itemsContainer');
      container.innerHTML = "";
      items.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'item-row d-flex gap-2 align-items-center';
        div.innerHTML = `
          <input type="text" class="form-control" value="${item.name}" placeholder="å“é …" onchange="updateItem(${index}, 'name', this.value)">
          <input type="number" class="form-control" value="${item.price}" placeholder="$" style="width: 80px;" onchange="updateItem(${index}, 'price', this.value)">
          <span class="del-btn" onclick="removeItem(${index})">âœ•</span>
        `;
        container.appendChild(div);
      });
      currentItems = items;
    }

    function addItem() {
      currentItems.push({name: "", price: ""});
      renderItems(currentItems);
    }

    function removeItem(index) {
      currentItems.splice(index, 1);
      renderItems(currentItems);
    }

    function updateItem(index, field, value) {
      currentItems[index][field] = value;
    }

    async function saveData() {
      const storeName = document.getElementById('storeName').value;
      const storePhone = document.getElementById('storePhone').value;
      if(!storeName) { alert("è«‹è¼¸å…¥åº—å®¶åç¨±"); return; }

      const btn = document.getElementById('saveBtn');
      btn.innerText = "è³‡æ–™å¯«å…¥ä¸­...";
      btn.disabled = true;

      try {
        const profile = await liff.getProfile();
        
        const payload = {
          action: "save_editor_data",
          userId: profile.userId,
          rowId: rowId,
          storeName: storeName,
          storePhone: storePhone,
          menuItems: currentItems
        };

        await fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) });
        
        alert("ä¿å­˜æˆåŠŸï¼");
        liff.closeWindow();
      } catch (err) {
        alert("å¤±æ•—ï¼š" + err.message);
        btn.innerText = "ç¢ºèªä¸¦æ›´æ–°è³‡æ–™åº«";
        btn.disabled = false;
      }
    }

    init();
  </script>
</body>
</html>
