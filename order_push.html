<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é»é¤é¸å–®(II)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background-color: #f4f7f6; padding: 10px; font-family: sans-serif; }
    .item-card { 
      background: white; border-radius: 12px; padding: 12px; 
      margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
    }
    .row-top { display: flex; align-items: center; margin-bottom: 8px; }
    .item-info { flex-grow: 1; padding-left: 10px; }
    .item-name { font-weight: bold; font-size: 16px; }
    .item-price { color: #28a745; font-size: 14px; margin-left: 8px; }
    .qty-group { 
      display: flex; align-items: center; background: #f8f9fa; 
      border-radius: 20px; padding: 2px 8px; 
    }
    .qty-btn { 
      width: 28px; height: 28px; border-radius: 50%; border: none;
      background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      font-weight: bold; color: #00B900;
    }
    .note-input {
      width: 100%; border: 1px solid #eee; border-radius: 8px;
      padding: 8px 12px; font-size: 13px; background-color: #fafafa;
    }
    .note-input:focus { border-color: #00B900; outline: none; background: #fff; }
    .submit-btn { 
      background-color: #00B900; color: white; border-radius: 50px; 
      font-weight: bold; padding: 15px; border: none; 
    }
  </style>
</head>
<body>
  <div class="container p-0">
    <div id="welcomeMsg" class="text-center mb-2 text-secondary small"></div>
    
    <h4 id="storeTitle" class="text-center fw-bold mb-3">ğŸ± è¼‰å…¥ä¸­...</h4>
    
    <div id="menuContainer"></div>
    
    <div id="loading" class="text-center py-5">
      <div class="spinner-border text-success"></div>
    </div>
    
    <button id="submitBtn" class="btn submit-btn w-100 mt-2 shadow" onclick="submitOrder()" style="display:none;">é€å‡ºè¨‚å–®</button>
    <button id="cancelBtn" class="btn btn-outline-danger w-100 mt-3 border-0" onclick="cancelMyOrder()" style="display:none;">ğŸ—‘ï¸ å–æ¶ˆæˆ‘åœ¨é€™å®¶åº—çš„è¨‚å–®</button>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = '2008939522-yZK6Iyb6'; 
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyDcGGvYcChszNtJRFL-HLD7Tv8aUmICLiCi4b2xhhPLtKCnO_NiRUViyL6gbQyq80ELA/exec'; 

    const urlParams = new URLSearchParams(window.location.search);
    const storeNameParam = urlParams.get('store');
    const targetIdFromUrl = urlParams.get('targetId'); 

    let currentMenu = []; 

    async function init() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }

        const profile = await liff.getProfile();
        // ç¢ºä¿å…ƒç´ å­˜åœ¨å¾Œå†è³¦å€¼
        const welcomeEl = document.getElementById('welcomeMsg');
        if(welcomeEl) welcomeEl.innerText = `Hi, ${profile.displayName}`;

        if (storeNameParam) {
          document.getElementById('storeTitle').innerText = storeNameParam; 
          loadMenu(storeNameParam);
        } else {
          document.getElementById('loading').style.display = 'none';
          alert("æ‰¾ä¸åˆ°åº—å®¶åç¨±ï¼Œè«‹å¾ LINE é‡æ–°é»æ“ŠæŒ‰éˆ•ã€‚");
        }
      } catch (err) {
        alert('åˆå§‹åŒ–å¤±æ•—ï¼š' + err.message);
      }
    }

    async function loadMenu(store) {
      try {
        const res = await fetch(`${GAS_API_URL}?action=getMenu&store=${encodeURIComponent(store)}`);
        const data = await res.json();
        currentMenu = data;
        renderMenu(data);
      } catch (e) {
        document.getElementById('loading').style.display = 'none';
        alert("è®€å–èœå–®å¤±æ•—ã€‚");
      }
    }

    // ğŸš€ å›å¾©æ‚¨è¦æ±‚çš„èœå–®é¡¯ç¤ºæ–¹å¼
    function renderMenu(items) {
      const container = document.getElementById('menuContainer');
      container.innerHTML = "";
      
      items.forEach((item, i) => {
        const div = document.createElement('div');
        div.className = "item-card";
        div.innerHTML = `
          <div class="row-top">
            <input type="checkbox" class="form-check-input" id="check${i}" style="transform: scale(1.3);">
            <div class="item-info">
              <span class="item-name">${item.name}</span>
              <span class="item-price">$${item.price}</span>
            </div>
            <div class="qty-group">
              <button class="qty-btn" onclick="updateQty(${i}, -1)">-</button>
              <span class="mx-2 fw-bold" id="qty${i}">1</span>
              <button class="qty-btn" onclick="updateQty(${i}, 1)">+</button>
            </div>
          </div>
          <input type="text" class="note-input" placeholder="æœ‰ä»€éº¼ç‰¹æ®Šè¦æ±‚å—ï¼Ÿ" id="note${i}">
        `;
        container.appendChild(div);
      });

      document.getElementById('loading').style.display = 'none';
      document.getElementById('submitBtn').style.display = 'block';
      document.getElementById('cancelBtn').style.display = 'block';
    }

    // æ›´æ–°æ•¸é‡çš„åŠ æ¸›é‚è¼¯
    function updateQty(index, delta) {
      const qtySpan = document.getElementById(`qty${index}`);
      const checkbox = document.getElementById(`check${index}`);
      let currentQty = parseInt(qtySpan.innerText);
      currentQty += delta;
      if (currentQty < 1) currentQty = 1;
      qtySpan.innerText = currentQty;
      // é»æ“ŠåŠ æ¸›æ™‚è‡ªå‹•å‹¾é¸
      if (delta > 0) checkbox.checked = true;
    }

    async function submitOrder() {
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerText = "å‚³é€ä¸­...";

      try {
        let orders = [];
        currentMenu.forEach((item, i) => {
          const isChecked = document.getElementById(`check${i}`).checked;
          const qty = parseInt(document.getElementById(`qty${i}`).innerText);
          const note = document.getElementById(`note${i}`).value;
          
          if (isChecked) {
            orders.push({ item: item.name, price: item.price, qty: qty, note: note });
          }
        });

        if (orders.length === 0) {
          alert("è«‹å…ˆå‹¾é¸æ‚¨è¦é»çš„é¤é»å–”ï¼");
          submitBtn.disabled = false;
          submitBtn.innerText = "é€å‡ºè¨‚å–®";
          return;
        }

        const profile = await liff.getProfile();
        const context = liff.getContext();
        
        // å„ªå…ˆä½¿ç”¨å¾ GAS å‚³ä¾†çš„ targetId (ç¾¤çµ„ ID)
        let finalTargetId = targetIdFromUrl;
        if (!finalTargetId) {
           finalTargetId = (context && (context.groupId || context.roomId)) || profile.userId;
        }

        const payload = {
          action: "direct_order",
          targetId: finalTargetId,
          userId: profile.userId,
          displayName: profile.displayName,
          storeName: storeNameParam,
          orders: orders
        };

        await fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) });
        alert("âœ… é»é¤æˆåŠŸï¼");
        liff.closeWindow();
      } catch (err) {
        alert("âŒ éŒ¯èª¤ï¼š" + err.message);
        submitBtn.disabled = false;
      }
    }

    async function cancelMyOrder() {
        if(!confirm("ç¢ºå®šè¦å–æ¶ˆè¨‚å–®å—ï¼Ÿ")) return;
        const profile = await liff.getProfile();
        const payload = {
            action: "cancel_order",
            targetId: targetIdFromUrl || profile.userId,
            userId: profile.userId,
            storeName: storeNameParam
        };
        await fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) });
        alert("ğŸ—‘ï¸ å·²å–æ¶ˆè¨‚å–®ï¼");
        liff.closeWindow();
    }
    
    init();
  </script>
</body>
</html>
