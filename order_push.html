<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é»é¤é¸å–®(IV) - æ¸…æ–°è–„è·ç‰ˆ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    /* ================== ğŸ¨ è‰²å½©å®šç¾©å€ ================== */
    :root {
      --primary-mint: #4FDAC1;       /* ä¸»è‰²èª¿ï¼šé®®æ˜è–„è·ç¶  (åƒè€ƒè‰²å¡ä¸­é–“) */
      --primary-mint-dark: #3CAEA3;  /* æ·±è‰²èª¿ï¼šç”¨æ–¼æŒ‰éˆ• hover æˆ–å¼·èª¿ */
      --bg-mint-light: #E8F8F5;      /* èƒŒæ™¯è‰²ï¼šæ¥µæ·ºè–„è·ç™½ (åƒè€ƒè‰²å¡æœ€å·¦) */
      --text-dark: #444444;          /* ä¸»è¦æ–‡å­—è‰² */
    }

    /* ================== å…¨å±€æ¨£å¼ ================== */
    body { 
      background-color: var(--bg-mint-light); /* æ”¹ç”¨æ·ºè–„è·èƒŒæ™¯ */
      padding: 10px; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: var(--text-dark);
    }

    /* æ¨™é¡Œé¡è‰²å¼·åŒ– */
    #storeTitle { color: #333; }

    /* ================== å¡ç‰‡èˆ‡å…§å®¹ ================== */
    .item-card { 
      background: white; 
      border-radius: 16px; /* åœ“è§’ç¨å¾®åŠ å¤§ä¸€é»æ›´å¯æ„› */
      padding: 15px; 
      margin-bottom: 12px; 
      box-shadow: 0 4px 12px rgba(79, 218, 193, 0.15); /* é™°å½±å¸¶ä¸€é»é»è–„è·è‰² */
      border: 1px solid rgba(79, 218, 193, 0.1); /* æ¥µç´°å¾®çš„é‚Šæ¡† */
    }
    .row-top { display: flex; align-items: flex-start; margin-bottom: 10px; }
    .item-info { flex-grow: 1; padding-left: 12px; }
    
    .item-name { 
      font-weight: bold; font-size: 16px; display: block; margin-bottom: 4px;
    }
    
    /* åƒ¹æ ¼æ”¹ç”¨ä¸»è‰²èª¿ï¼Œä¸¦åŠ ç²— */
    .item-price { 
      color: var(--primary-mint); 
      font-weight: 800; font-size: 15px; 
    }

    /* å‚™è¨»èªªæ˜æ–‡å­— */
    .item-memo {
      font-size: 12px; color: #999; margin-top: 4px;
    }

    /* ================== äº’å‹•å…ƒä»¶ ================== */
    /* Checkbox å‹¾é¸å¾Œçš„é¡è‰² */
    .form-check-input:checked {
      background-color: var(--primary-mint);
      border-color: var(--primary-mint);
    }
    .form-check-input { cursor: pointer; }

    /* åŠ æ¸›æ•¸é‡å€å¡Š */
    .qty-group { 
      display: flex; align-items: center; 
      background: var(--bg-mint-light); /* èƒŒæ™¯æ”¹ç”¨æ·ºè–„è·è‰² */
      border-radius: 20px; padding: 4px 8px;
      margin-top: 5px;
    }
    .qty-btn { 
      width: 30px; height: 30px; border-radius: 50%; border: none;
      background: #fff; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      font-weight: 900; font-size: 16px;
      color: var(--primary-mint); /* æŒ‰éˆ•æ–‡å­—é¡è‰² */
      transition: all 0.2s;
    }
    .qty-btn:active { background-color: var(--primary-mint); color: white; }
    .qty-num { font-weight: bold; margin: 0 10px; color: #555; }

    /* å‚™è¨»è¼¸å…¥æ¡† */
    .note-input {
      width: 100%; border: 1px solid #eee; border-radius: 10px;
      padding: 10px 12px; font-size: 13px; background-color: #fcfcfc;
      transition: border-color 0.3s;
    }
    /* è¼¸å…¥æ¡†èšç„¦æ™‚çš„é¡è‰² */
    .note-input:focus { 
      border-color: var(--primary-mint); 
      box-shadow: 0 0 0 3px rgba(79, 218, 193, 0.2); /* è–„è·è‰²å…‰æšˆ */
      outline: none; background: #fff; 
    }

    /* ================== ä¸»æŒ‰éˆ• ================== */
    .submit-btn { 
      background-color: var(--primary-mint); /* ä¸»è‰²èª¿èƒŒæ™¯ */
      color: white; border-radius: 50px; 
      font-weight: bold; padding: 15px; border: none; 
      box-shadow: 0 4px 10px rgba(79, 218, 193, 0.4); /* æŒ‰éˆ•é™°å½± */
      transition: background-color 0.3s;
    }
    .submit-btn:hover, .submit-btn:active {
      background-color: var(--primary-mint-dark) !important; /* hover æ™‚è®Šæ·±ä¸€é» */
      color: white;
    }

    /* å–æ¶ˆæŒ‰éˆ•æ¨£å¼èª¿æ•´ */
    .btn-outline-danger {
      border-radius: 50px; padding: 12px;
      color: #ff6b6b; border-color: #ff6b6b;
    }
    .btn-outline-danger:hover { background-color: #ff6b6b; color: white; }

    /* è¼‰å…¥ä¸­çš„è½‰åœˆåœˆé¡è‰²è¦†è“‹ Bootstrap é è¨­ */
    .text-success { color: var(--primary-mint) !important; }
  </style>
</head>
<body>
  <div class="container p-0" style="max-width: 600px;">
    <div id="welcomeMsg" class="text-center mb-2 text-secondary small" style="opacity: 0.8;"></div>
    
    <h4 id="storeTitle" class="text-center fw-bold mb-4" style="letter-spacing: 1px;">ğŸ± è¼‰å…¥ä¸­...</h4>
    
    <div id="menuContainer"></div>
    
    <div id="loading" class="text-center py-5">
      <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"></div>
      <div class="mt-2" style="color: var(--primary-mint);">æ­£åœ¨æº–å‚™èœå–®...</div>
    </div>
    
    <div class="p-2">
      <button id="submitBtn" class="btn submit-btn w-100 mt-3 mb-2" onclick="submitOrder()" style="display:none;">é€å‡ºè¨‚å–®</button>
      <button id="cancelBtn" class="btn btn-outline-danger w-100 border-0" onclick="cancelMyOrder()" style="display:none; font-size: 14px;">ğŸ—‘ï¸ å–æ¶ˆæˆ‘åœ¨é€™å®¶åº—çš„è¨‚å–®</button>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = '2008939522-yZK6Iyb6'; 
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyDcGGvYcChszNtJRFL-HLD7Tv8aUmICLiCi4b2xhhPLtKCnO_NiRUViyL6gbQyq80ELA/exec'; 

    const urlParams = new URLSearchParams(window.location.search);
    const storeNameParam = urlParams.get('store');
    const targetIdFromUrl = urlParams.get('targetId'); 

    let currentMenu = []; 

    async function init() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }

        const profile = await liff.getProfile();
        const welcomeEl = document.getElementById('welcomeMsg');
        if(welcomeEl) welcomeEl.innerText = `Hi, ${profile.displayName}`;

        if (storeNameParam) {
          document.getElementById('storeTitle').innerText = storeNameParam; 
          loadMenu(storeNameParam);
        } else {
          document.getElementById('loading').style.display = 'none';
          alert("æ‰¾ä¸åˆ°åº—å®¶åç¨±ï¼Œè«‹å¾ LINE é‡æ–°é»æ“ŠæŒ‰éˆ•ã€‚");
        }
      } catch (err) {
        alert('åˆå§‹åŒ–å¤±æ•—ï¼š' + err.message);
      }
    }

    async function loadMenu(store) {
      try {
        // æ³¨æ„ï¼šé€™è£¡ç¢ºèªæœ‰åŒ…å«ä¸Šä¸€ç‰ˆè¦æ±‚çš„ &action=getMenu
        const res = await fetch(`${GAS_API_URL}?action=getMenu&store=${encodeURIComponent(store)}`);
        const data = await res.json();
        currentMenu = data;
        renderMenu(data);
      } catch (e) {
        document.getElementById('loading').style.display = 'none';
        alert("è®€å–èœå–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
      }
    }

    function renderMenu(items) {
      const container = document.getElementById('menuContainer');
      container.innerHTML = "";
      
      items.forEach((item, i) => {
        // è™•ç†å‚™è¨»é¡¯ç¤º HTML
        const memoHtml = item.memo ? `<div class="item-memo">â„¹ï¸ ${item.memo}</div>` : "";
        // è™•ç†è¼¸å…¥æ¡†æç¤ºæ–‡å­—
        const placeholderText = item.memo ? `å‚™è¨» (é è¨­: ${item.memo})` : "æœ‰ä»€éº¼ç‰¹æ®Šè¦æ±‚å—ï¼Ÿ(å¦‚ï¼šä¸è¾£ã€å»å†°)";

        const div = document.createElement('div');
        div.className = "item-card";
        div.innerHTML = `
          <div class="row-top">
            <div style="padding-top: 4px;">
                <input type="checkbox" class="form-check-input" id="check${i}" style="transform: scale(1.3);">
            </div>
            <div class="item-info">
              <span class="item-name">${item.name}</span>
              <span class="item-price">$${item.price}</span>
              ${memoHtml} </div>
            <div>
                <div class="qty-group">
                <button class="qty-btn" onclick="updateQty(${i}, -1)">-</button>
                <span class="qty-num" id="qty${i}">1</span>
                <button class="qty-btn" onclick="updateQty(${i}, 1)">+</button>
                </div>
            </div>
          </div>
          <input type="text" class="note-input" placeholder="${placeholderText}" id="note${i}">
        `;
        container.appendChild(div);
      });

      document.getElementById('loading').style.display = 'none';
      document.getElementById('submitBtn').style.display = 'block';
      document.getElementById('cancelBtn').style.display = 'block';
    }

    function updateQty(index, delta) {
      const qtySpan = document.getElementById(`qty${index}`);
      const checkbox = document.getElementById(`check${index}`);
      let currentQty = parseInt(qtySpan.innerText);
      currentQty += delta;
      if (currentQty < 1) currentQty = 1;
      qtySpan.innerText = currentQty;
      if (delta > 0) checkbox.checked = true;
    }

    async function submitOrder() {
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerText = "æ­£åœ¨å‚³é€è¨‚å–®...";
      submitBtn.style.opacity = "0.7";

      try {
        let orders = [];
        currentMenu.forEach((item, i) => {
          const isChecked = document.getElementById(`check${i}`).checked;
          const qty = parseInt(document.getElementById(`qty${i}`).innerText);
          const note = document.getElementById(`note${i}`).value;
          
          if (isChecked && qty > 0) {
            orders.push({ item: item.name, price: item.price, qty: qty, note: note });
          }
        });

        if (orders.length === 0) {
          alert("è«‹å…ˆå‹¾é¸æ‚¨è¦é»çš„é¤é»å–”ï¼");
          submitBtn.disabled = false;
          submitBtn.innerText = "é€å‡ºè¨‚å–®";
          submitBtn.style.opacity = "1";
          return;
        }

        const profile = await liff.getProfile();
        const context = liff.getContext();
        
        let finalTargetId = targetIdFromUrl;
        if (!finalTargetId) {
           finalTargetId = (context && (context.groupId || context.roomId)) || profile.userId;
        }

        const payload = {
          action: "direct_order",
          targetId: finalTargetId,
          userId: profile.userId,
          displayName: profile.displayName,
          storeName: storeNameParam,
          orders: orders
        };

        await fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) });
        
        // æˆåŠŸå¾Œçš„è¦–è¦ºå›é¥‹
        submitBtn.innerText = "âœ… é»é¤æˆåŠŸï¼";
        submitBtn.style.backgroundColor = "#4CD9B0";
        setTimeout(() => { liff.closeWindow(); }, 1000);

      } catch (err) {
        alert("âŒ éŒ¯èª¤ï¼š" + err.message);
        submitBtn.disabled = false;
        submitBtn.innerText = "é€å‡ºè¨‚å–®";
        submitBtn.style.opacity = "1";
      }
    }

    async function cancelMyOrder() {
        if(!confirm("ç¢ºå®šè¦å–æ¶ˆæ‚¨åœ¨é€™å®¶åº—çš„æ‰€æœ‰è¨‚å–®å—ï¼Ÿ")) return;
        const btn = document.getElementById('cancelBtn');
        btn.innerText = "æ­£åœ¨å–æ¶ˆ...";
        btn.disabled = true;

        try {
            const profile = await liff.getProfile();
            const payload = {
                action: "cancel_order",
                targetId: targetIdFromUrl || profile.userId,
                userId: profile.userId,
                storeName: storeNameParam
            };
            await fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) });
            alert("ğŸ—‘ï¸ å·²å–æ¶ˆè¨‚å–®ï¼");
            liff.closeWindow();
        } catch (e) {
             alert("å–æ¶ˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
             btn.innerText = "ğŸ—‘ï¸ å–æ¶ˆæˆ‘åœ¨é€™å®¶åº—çš„è¨‚å–®";
             btn.disabled = false;
        }
    }
    
    init();
  </script>
</body>
</html>
