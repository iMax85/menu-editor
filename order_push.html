<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é»é¤é¸å–®(II)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background-color: #f4f7f6; padding: 10px; font-family: sans-serif; }
    
    .item-card { 
      background: white; 
      border-radius: 12px; 
      padding: 12px; 
      margin-bottom: 12px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
    }

    /* ç¬¬ä¸€åˆ—ä½ˆå±€ */
    .row-top { display: flex; align-items: center; margin-bottom: 8px; }

    .item-info { flex-grow: 1; padding-left: 10px; }
    
    /* ä¿®æ­£é»ï¼šç§»é™¤ display: block è®“åç¨±èˆ‡åƒ¹æ ¼åŒåˆ— */
    .item-name { font-weight: bold; font-size: 16px; }
    .item-price { color: #28a745; font-size: 14px; margin-left: 8px; }

    .qty-group { 
      display: flex; align-items: center; 
      background: #f8f9fa; border-radius: 20px; padding: 2px 8px; 
    }
    .qty-btn { 
      width: 28px; height: 28px; border-radius: 50%; border: none;
      background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      font-weight: bold; color: #00B900;
    }

    .note-input {
      width: 100%;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 13px;
      background-color: #fafafa;
    }
    .note-input:focus { border-color: #00B900; outline: none; background: #fff; }

    .submit-btn { background-color: #00B900; color: white; border-radius: 50px; font-weight: bold; padding: 15px; border: none; }
  </style>
</head>
<body>
  <div class="container p-0">
    <h4 id="storeTitle" class="text-center fw-bold mb-3">ğŸ± è¼‰å…¥ä¸­...</h4>
    <div id="menuList"></div>
    <div id="loading" class="text-center py-5"><div class="spinner-border text-success"></div></div>
    
    <button id="submitBtn" class="btn submit-btn w-100 mt-2 shadow" onclick="submitOrder()" style="display:none;">é€å‡ºè¨‚å–®</button>
    <button id="cancelBtn" class="btn btn-outline-danger w-100 mt-3 border-0" onclick="cancelMyOrder()" style="display:none;">ğŸ—‘ï¸ å–æ¶ˆæˆ‘åœ¨é€™å®¶åº—çš„è¨‚å–®</button>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = '2008939522-yZK6Iyb6'; 
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyDcGGvYcChszNtJRFL-HLD7Tv8aUmICLiCi4b2xhhPLtKCnO_NiRUViyL6gbQyq80ELA/exec'; 

    // ğŸš€ é—œéµä¿®æ­£ 1ï¼šä¸€é€²ä¾†å°±å…ˆæŠ“ç¶²å€ä¸Šçš„åƒæ•¸ (GAS å‚³ä¾†çš„)
  const urlParams = new URLSearchParams(window.location.search);
  const storeNameParam = urlParams.get('store');
  const targetIdFromUrl = urlParams.get('targetId'); // é€™æ˜¯ GAS å‚³ä¾†çš„æ­£ç¢ºç¾¤çµ„ ID

  let currentMenu = []; // å­˜æ”¾èœå–®è³‡æ–™

  // ================= 2. åˆå§‹åŒ–å‡½å¼ (init) =================
  async function init() {
    try {
      await liff.init({ liffId: LIFF_ID });

      // æª¢æŸ¥æ˜¯å¦ç™»å…¥
      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      // é¡¯ç¤ºæ­¡è¿è¨Šæ¯
      const profile = await liff.getProfile();
      document.getElementById('welcomeMsg').innerText = `Hi, ${profile.displayName}`;

      // è¼‰å…¥èœå–®
      if (storeNameParam) {
        document.getElementById('storeTitle').innerText = storeNameParam; // é¡¯ç¤ºåº—å
        loadMenu(storeNameParam);
      } else {
        alert("âŒ ç¶²å€åƒæ•¸éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°åº—å®¶åç¨±ï¼Œè«‹å¾ LINE é‡æ–°é»æ“ŠæŒ‰éˆ•ã€‚");
      }

    } catch (err) {
      console.error('LIFF Initialization failed', err);
      alert('LIFF åˆå§‹åŒ–å¤±æ•—ï¼š' + err.message);
    }
  }

  // è®€å–èœå–®è³‡æ–™ (ä¿æŒä¸è®Šï¼Œä½†ç‚ºäº†å®Œæ•´æ€§åˆ—å‡ºä¾†)
  async function loadMenu(store) {
    try {
      const res = await fetch(`${GAS_API_URL}?action=getMenu&store=${encodeURIComponent(store)}`);
      const data = await res.json();
      currentMenu = data;
      renderMenu(data);
    } catch (e) {
      alert("è®€å–èœå–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    }
  }

  // æ¸²æŸ“èœå–® (ä¿æŒä¸è®Š)
  function renderMenu(items) {
    const container = document.getElementById('menuContainer');
    container.innerHTML = "";
    items.forEach((item, index) => {
      // ç°¡å–®çš„ HTML çµæ§‹ï¼Œæ‚¨å¯ä»¥ä¿ç•™æ‚¨åŸæœ¬ç¾åŒ–çš„æ¨£å¼
      const div = document.createElement('div');
      div.className = "card mb-2 shadow-sm";
      div.innerHTML = `
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <h5 class="card-title mb-0">${item.name}</h5>
            <small class="text-muted">$${item.price}</small>
          </div>
          <div class="d-flex align-items-center gap-2">
            <input type="number" class="form-control" id="qty-${index}" value="0" min="0" style="width: 60px;">
            <input type="text" class="form-control" id="note-${index}" placeholder="å‚™è¨»" style="width: 80px; font-size: 12px;">
          </div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  // ================= 3. é€å‡ºè¨‚å–®å‡½å¼ (submitOrder) =================
  async function submitOrder() {
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerText = "å‚³é€ä¸­...";

    try {
      // 1. æ”¶é›†è¨‚å–®å…§å®¹
      let orders = [];
      let totalQty = 0;
      
      currentMenu.forEach((item, index) => {
        const qtyInput = document.getElementById(`qty-${index}`);
        const noteInput = document.getElementById(`note-${index}`);
        const qty = parseInt(qtyInput.value);
        
        if (qty > 0) {
          orders.push({
            item: item.name,
            price: item.price,
            qty: qty,
            note: noteInput.value
          });
          totalQty += qty;
        }
      });

      if (totalQty === 0) {
        alert("æ‚¨é‚„æ²’é¸æ“‡ä»»ä½•é¤é»å–”ï¼");
        submitBtn.disabled = false;
        submitBtn.innerText = "é€å‡ºè¨‚å–®";
        return;
      }

      // 2. å–å¾—ä½¿ç”¨è€…è³‡æ–™
      const profile = await liff.getProfile();
      const context = liff.getContext();

      // ğŸš€ é—œéµä¿®æ­£ 2ï¼šæ±ºå®š targetId çš„å„ªå…ˆé †åº
      // å„ªå…ˆæ¬Šï¼šç¶²å€åƒæ•¸ (targetIdFromUrl) > LIFF Context ç¾¤çµ„ ID > ä½¿ç”¨è€… ID
      let finalTargetId = targetIdFromUrl;
      
      if (!finalTargetId) {
         // å¦‚æœç¶²å€æ²’å¸¶åƒæ•¸ (ä¾‹å¦‚ç›´æ¥é–‹ç¶²é )ï¼Œå˜—è©¦æŠ“ LIFF context
         if (context && (context.type === 'group' || context.type === 'room')) {
             finalTargetId = context.groupId || context.roomId;
         } else {
             finalTargetId = profile.userId; // æœ€å¾Œé€€è·¯ï¼šç•¶ä½œæ˜¯ç§è¨Š
         }
      }

      // 3. æº–å‚™å‚³é€çµ¦ GAS çš„è³‡æ–™åŒ…
      const payload = {
        action: "direct_order",
        targetId: finalTargetId, // ğŸ‘ˆ é€™è£¡å‚³é€æ­£ç¢ºçš„ ID çµ¦ GAS
        userId: profile.userId,
        displayName: profile.displayName,
        storeName: storeNameParam,
        orders: orders
      };

      // 4. ç™¼é€è«‹æ±‚
      // ä½¿ç”¨ no-cors é›–ç„¶ä¸æœƒå ±éŒ¯ï¼Œä½†ç„¡æ³•è®€å–å›æ‡‰ï¼Œå»ºè­°æ¨™æº– fetch
      // é€™è£¡å‡è¨­æ‚¨çš„ GAS æœ‰æ­£ç¢ºè™•ç† CORS (å›å‚³ JSON)
      await fetch(GAS_API_URL, {
        method: "POST",
        body: JSON.stringify(payload)
      });

      // 5. æˆåŠŸå¾Œé—œé–‰è¦–çª—
      alert("âœ… é»é¤æˆåŠŸï¼");
      liff.closeWindow();

    } catch (err) {
      alert("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
      submitBtn.disabled = false;
      submitBtn.innerText = "é€å‡ºè¨‚å–®";
    }
  }
  
  // å•Ÿå‹•åˆå§‹åŒ–
  init();
  </script>
</body>
</html>
