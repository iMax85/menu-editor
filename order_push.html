<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é»é¤é¸å–®(II)</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    /* ================== ğŸ¨ è‰²å½©å®šç¾©å€ (æš–æ©˜è‰²ç³») ================== */
    :root {
      --primary-orange: #FF8C42;     /* ä¸»è‰²èª¿ï¼šæ´»åŠ›æ©˜ (å°æ‡‰é ­åƒ) */
      --primary-dark: #F2711C;       /* æ·±è‰²èª¿ï¼šæŒ‰éˆ• hover ç”¨ */
      --bg-cream: #FFFBF5;           /* èƒŒæ™¯è‰²ï¼šæº«æš–å¥¶æ²¹ç™½ */
      --text-dark: #5D4037;          /* æ–‡å­—è‰²ï¼šæ·±å’–å•¡è‰² (æ¯”ç´”é»‘æŸ”å’Œ) */
      --price-color: #E65100;        /* åƒ¹æ ¼è‰²ï¼šæ·±æ©˜ç´…ï¼Œå¼·èª¿é‡‘é¡ */
    }

    /* ================== å…¨å±€æ¨£å¼ ================== */
    body { 
      background-color: var(--bg-cream); 
      padding: 10px; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: var(--text-dark);
    }

    /* æ¨™é¡Œ */
    #storeTitle { color: var(--text-dark); letter-spacing: 1px; }

    /* ================== å¡ç‰‡èˆ‡æ’ç‰ˆ ================== */
    .item-card { 
      background: white; 
      border-radius: 16px; 
      padding: 12px 15px; 
      margin-bottom: 12px; 
      box-shadow: 0 4px 10px rgba(255, 140, 66, 0.1); /* æ©˜è‰²æ·¡æ·¡é™°å½± */
      border: 1px solid rgba(255, 140, 66, 0.15); 
    }

    /* ç¬¬ä¸€åˆ—ï¼šCheckbox + æ–‡å­—è³‡è¨Š + æ•¸é‡æŒ‰éˆ• */
    .row-top { 
      display: flex; 
      align-items: center; /* å‚ç›´ç½®ä¸­ */
      margin-bottom: 10px; 
    }

    /* ä¿®æ­£é»ï¼šè®“ä¸­é–“çš„è³‡è¨Šå€å¡Šå…§çš„æ–‡å­—èƒ½ã€Œæ¥çºŒæ’åˆ—ã€ */
    .item-info { 
      flex-grow: 1; 
      padding-left: 10px; 
      padding-right: 5px;
      line-height: 1.4; /* è¡Œè·ç¨å¾®æ‹‰é–‹ä¸€é»æ¯”è¼ƒå¥½è®€ */
    }
    
    /* å“åï¼šåŠ ç²—ï¼Œæ·±è‰² */
    .item-name { 
      font-weight: bold; 
      font-size: 16px; 
      color: var(--text-dark);
      margin-right: 6px; /* èˆ‡åƒ¹æ ¼çš„é–“è· */
    }
    
    /* åƒ¹æ ¼ï¼šæ©˜ç´…è‰²ï¼ŒåŠ ç²— */
    .item-price { 
      color: var(--price-color); 
      font-weight: 800; 
      font-size: 15px; 
      margin-right: 6px; /* èˆ‡å‚™è¨»çš„é–“è· */
    }

    /* èœå–®å‚™è¨»ï¼šç°è‰²å°å­—ï¼Œåº•è‰²æ¨™ç±¤æ„Ÿ */
    .item-memo {
      font-size: 12px; 
      color: #999; 
      background-color: #F5F5F5;
      padding: 2px 6px;
      border-radius: 4px;
      display: inline-block; /* ä¿æŒæ•´å¡Šä¸è¢«æ‰“æ–· */
      vertical-align: middle;
    }

    /* ================== äº’å‹•å…ƒä»¶ ================== */
    /* Checkbox */
    .form-check-input:checked {
      background-color: var(--primary-orange);
      border-color: var(--primary-orange);
    }
    .form-check-input { 
      cursor: pointer; 
      width: 1.3em; height: 1.3em; /* ç¨å¾®æ”¾å¤§ä¸€é» */
      margin-top: 0; /* ä¿®æ­£ Bootstrap é è¨­ä½ç§» */
    }

    /* åŠ æ¸›æ•¸é‡å€å¡Š */
    .qty-group { 
      display: flex; align-items: center; 
      background: #FFF0E0; /* æ·ºæ©˜è‰²èƒŒæ™¯ */
      border-radius: 20px; padding: 2px 4px;
      flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
    }
    .qty-btn { 
      width: 28px; height: 28px; border-radius: 50%; border: none;
      background: #fff; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      font-weight: 900; font-size: 16px;
      color: var(--primary-orange);
    }
    .qty-btn:active { background-color: var(--primary-orange); color: white; }
    .qty-num { font-weight: bold; margin: 0 8px; color: var(--text-dark); min-width: 16px; text-align: center; }

    /* ç¬¬äºŒåˆ—ï¼šé»é¤å‚™è¨»è¼¸å…¥æ¡† */
    .note-input {
      width: 100%; border: 1px solid #eee; border-radius: 10px;
      padding: 10px 12px; font-size: 13px; background-color: #FAFAFA;
      transition: border-color 0.3s;
    }
    .note-input:focus { 
      border-color: var(--primary-orange); 
      box-shadow: 0 0 0 3px rgba(255, 140, 66, 0.2); 
      outline: none; background: #fff; 
    }

    /* ================== æŒ‰éˆ• ================== */
    .submit-btn { 
      background-color: var(--primary-orange); 
      color: white; border-radius: 50px; 
      font-weight: bold; padding: 15px; border: none; 
      box-shadow: 0 4px 12px rgba(255, 140, 66, 0.3);
    }
    .submit-btn:hover, .submit-btn:active {
      background-color: var(--primary-dark) !important;
      color: white;
    }
    
    .btn-outline-danger {
      border-radius: 50px; 
      color: #FF6B6B; border-color: #FF6B6B;
    }
    .btn-outline-danger:hover { background-color: #FF6B6B; color: white; }

    /* è¼‰å…¥å‹•ç•«é¡è‰² */
    .text-success { color: var(--primary-orange) !important; }
  </style>
</head>
<body>
  <div class="container p-0" style="max-width: 600px;">
    <div id="welcomeMsg" class="text-center mb-2 small" style="color: #888;"></div>
    
    <h4 id="storeTitle" class="text-center fw-bold mb-4">ğŸ± è¼‰å…¥ä¸­...</h4>
    
    <div id="menuContainer"></div>
    
    <div id="loading" class="text-center py-5">
      <div class="spinner-border text-success" role="status"></div>
      <div class="mt-2" style="color: var(--primary-orange);">èœå–®æº–å‚™ä¸­...</div>
    </div>
    
    <div class="p-2">
      <button id="submitBtn" class="btn submit-btn w-100 mt-2 mb-2" onclick="submitOrder()" style="display:none;">é€å‡ºè¨‚å–®</button>
      <button id="cancelBtn" class="btn btn-outline-danger w-100 border-0" onclick="cancelMyOrder()" style="display:none; font-size: 14px;">ğŸ—‘ï¸ å–æ¶ˆæˆ‘åœ¨é€™å®¶åº—çš„è¨‚å–®</button>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const LIFF_ID = '2008939522-yZK6Iyb6'; 
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyDcGGvYcChszNtJRFL-HLD7Tv8aUmICLiCi4b2xhhPLtKCnO_NiRUViyL6gbQyq80ELA/exec'; 

    const urlParams = new URLSearchParams(window.location.search);
    const storeNameParam = urlParams.get('store');
    const targetIdFromUrl = urlParams.get('targetId'); 

    let currentMenu = []; 

    async function init() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) { liff.login(); return; }

        const profile = await liff.getProfile();
        const welcomeEl = document.getElementById('welcomeMsg');
        if(welcomeEl) welcomeEl.innerText = `Hi, ${profile.displayName}`;

        if (storeNameParam) {
          document.getElementById('storeTitle').innerText = storeNameParam; 
          loadMenu(storeNameParam);
        } else {
          document.getElementById('loading').style.display = 'none';
          alert("æ‰¾ä¸åˆ°åº—å®¶åç¨±ï¼Œè«‹å¾ LINE é‡æ–°é»æ“ŠæŒ‰éˆ•ã€‚");
        }
      } catch (err) {
        alert('åˆå§‹åŒ–å¤±æ•—ï¼š' + err.message);
      }
    }

    async function loadMenu(store) {
      try {
        const res = await fetch(`${GAS_API_URL}?action=getMenu&store=${encodeURIComponent(store)}`);
        const data = await res.json();
        currentMenu = data;
        renderMenu(data);
      } catch (e) {
        document.getElementById('loading').style.display = 'none';
        alert("è®€å–èœå–®å¤±æ•—ã€‚");
      }
    }

    function renderMenu(items) {
      const container = document.getElementById('menuContainer');
      container.innerHTML = "";
      
      items.forEach((item, i) => {
        // è™•ç†å‚™è¨»é¡¯ç¤º HTML
        const memoHtml = item.memo ? `<span class="item-memo">â„¹ï¸ ${item.memo}</span>` : "";
        // è™•ç†è¼¸å…¥æ¡†æç¤ºæ–‡å­—
        const placeholderText = item.memo ? `å‚™è¨» (é è¨­: ${item.memo})` : "æœ‰ä»€éº¼ç‰¹æ®Šè¦æ±‚å—ï¼Ÿ";

        const div = document.createElement('div');
        div.className = "item-card";
        div.innerHTML = `
          <div class="row-top">
            <div style="display: flex; align-items: center;">
                <input type="checkbox" class="form-check-input" id="check${i}">
            </div>
            
            <div class="item-info">
              <span class="item-name">${item.name}</span>
              <span class="item-price">$${item.price}</span>
              ${memoHtml}
            </div>
            
            <div class="qty-group">
                <button class="qty-btn" onclick="updateQty(${i}, -1)">-</button>
                <span class="qty-num" id="qty${i}">1</span>
                <button class="qty-btn" onclick="updateQty(${i}, 1)">+</button>
            </div>
          </div>
          
          <input type="text" class="note-input" placeholder="${placeholderText}" id="note${i}">
        `;
        container.appendChild(div);
      });

      document.getElementById('loading').style.display = 'none';
      document.getElementById('submitBtn').style.display = 'block';
      document.getElementById('cancelBtn').style.display = 'block';
    }

    function updateQty(index, delta) {
      const qtySpan = document.getElementById(`qty${index}`);
      const checkbox = document.getElementById(`check${index}`);
      let currentQty = parseInt(qtySpan.innerText);
      currentQty += delta;
      if (currentQty < 1) currentQty = 1;
      qtySpan.innerText = currentQty;
      if (delta > 0) checkbox.checked = true;
    }

    async function submitOrder() {
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerText = "å‚³é€ä¸­...";
      submitBtn.style.opacity = "0.7";

      try {
        let orders = [];
        currentMenu.forEach((item, i) => {
          const isChecked = document.getElementById(`check${i}`).checked;
          const qty = parseInt(document.getElementById(`qty${i}`).innerText);
          const note = document.getElementById(`note${i}`).value;
          
          if (isChecked && qty > 0) {
            orders.push({ item: item.name, price: item.price, qty: qty, note: note });
          }
        });

        if (orders.length === 0) {
          alert("è«‹å…ˆå‹¾é¸é¤é»ï¼");
          submitBtn.disabled = false;
          submitBtn.innerText = "é€å‡ºè¨‚å–®";
          submitBtn.style.opacity = "1";
          return;
        }

        const profile = await liff.getProfile();
        const context = liff.getContext();
        
        let finalTargetId = targetIdFromUrl;
        if (!finalTargetId) {
           finalTargetId = (context && (context.groupId || context.roomId)) || profile.userId;
        }

        const payload = {
          action: "direct_order",
          targetId: finalTargetId,
          userId: profile.userId,
          displayName: profile.displayName,
          storeName: storeNameParam,
          orders: orders
        };

        await fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) });
        
        /*submitBtn.innerText = "âœ… æˆåŠŸï¼";
        submitBtn.style.backgroundColor = "#4CD9B0"; 
        setTimeout(() => { liff.closeWindow(); }, 1000); */
        // ğŸš€ çœéŒ¢é—œéµï¼šæ”¹ç”¨ LIFF å¹«ä½¿ç”¨è€…ç™¼é€è¨Šæ¯åˆ°ç¾¤çµ„ (å…è²»!)
        if (liff.isInClient()) {
            // çµ„è£è¦ç™¼é€çš„è¨Šæ¯
            const orderDetails = orders.map(o => {
                const noteText = o.note ? `(${o.note})` : "";
                return `${o.item} ${noteText} $${o.price} x${o.qty}`;
            }).join('\n');

            const msgText = `âœ… æˆ‘é»å¥½å›‰ï¼\n${orderDetails}`;

            try {
                await liff.sendMessages([{ type: 'text', text: msgText }]);
            } catch (error) {
                // å¦‚æœæ˜¯åœ¨å¤–éƒ¨ç€è¦½å™¨é–‹å•Ÿï¼ŒsendMessages æœƒå¤±æ•—ï¼Œé€™è£¡å¯ä»¥å¿½ç•¥æˆ–æ”¹ç”¨ alert
                console.log("LIFF sendMessages failed (maybe external browser)");
            }
        }

        submitBtn.innerText = "âœ… æˆåŠŸï¼";
        submitBtn.style.backgroundColor = "#4CD9B0"; 
        
        // ç¨å¾®å»¶é²é—œé–‰ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°æˆåŠŸè¨Šæ¯
        setTimeout(() => { liff.closeWindow(); }, 1000);

      } catch (err) {
        alert("éŒ¯èª¤ï¼š" + err.message);
        submitBtn.disabled = false;
        submitBtn.innerText = "é€å‡ºè¨‚å–®";
        submitBtn.style.opacity = "1";
      }
    }

    async function cancelMyOrder() {
        if(!confirm("ç¢ºå®šè¦å–æ¶ˆè¨‚å–®å—ï¼Ÿ")) return;
        const btn = document.getElementById('cancelBtn');
        btn.innerText = "è™•ç†ä¸­...";
        btn.disabled = true;

        try {
            const profile = await liff.getProfile();
            const payload = {
                action: "cancel_order",
                targetId: targetIdFromUrl || profile.userId,
                userId: profile.userId,
                storeName: storeNameParam
            };
            await fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) });
            alert("å·²å–æ¶ˆè¨‚å–®");
            liff.closeWindow();
        } catch (e) {
             alert("å–æ¶ˆå¤±æ•—");
             btn.innerText = "ğŸ—‘ï¸ å–æ¶ˆæˆ‘åœ¨é€™å®¶åº—çš„è¨‚å–®";
             btn.disabled = false;
        }
    }
    
    init();
  </script>
</body>
</html>
